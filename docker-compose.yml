# --- Shared Configurations ---
x-common-env: &common-env
  SCENE_NAME: ${SCENE_NAME}
  DATA_ROOT: ${DATA_ROOT}
  OUTPUT_ROOT: ${OUTPUT_ROOT}
  CUDA_HOME: /usr/local/cuda
  TORCH_CUDA_ARCH_LIST: ${TORCH_CUDA_ARCH_LIST}

x-gpu-build: &gpu-build
  args:
    CUDA_HOME: "/usr/local/cuda"
    TORCH_CUDA_ARCH_LIST: "${TORCH_CUDA_ARCH_LIST}"

x-gpu-deploy: &gpu-deploy
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: all
            capabilities: [gpu]

# --- Services ---
services:
  preprocessor:
    build: ./modules/preprocessor
    image: preprocessor:latest
    container_name: preprocessor_container
    environment:
      <<: *common-env
      FPS_EXTRACT: ${FPS_EXTRACT}
      CAPTURE_FRAMERATE: ${CAPTURE_FRAMERATE}
    volumes:
      - ./data:/data
    command: ["./pre_process.sh"] 

  da3:
    <<: *gpu-deploy
    build:
      <<: *gpu-build
      context: ./modules/da3
    image: da3:latest
    container_name: da3_container
    environment:
      <<: *common-env
    volumes:
      - ./data:/data
      - ./data/cache/da3:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["python3", "./da3_process.py"]

  sam3:
    <<: *gpu-deploy
    build: ./modules/sam3
    image: sam3:latest
    container_name: sam3_container
    environment:
      <<: *common-env
      HF_TOKEN: ${HF_TOKEN}
      SAM3_MIN_SCORE: ${SAM3_MIN_SCORE}
      SAM3_MIN_FRAME_DURATION: ${SAM3_MIN_FRAME_DURATION}
    volumes:
      - ./data:/data
      - ./data/cache/sam3:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./modules/sam3/prompts.txt:/app/sam3/prompts.txt
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["python3", "./sam3_process.py"]

  holoscene:
    <<: *gpu-deploy
    build:
      <<: *gpu-build
      context: ./modules/holoscene
    image: holoscene:latest
    container_name: holoscene_container
    ipc: host
    environment:
      <<: *common-env
      WANDB_MODE: disabled
    volumes:
      - ./data:/data
      - ./data/cache/holoscene:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./data/output:/app/holoscene/exps
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["./hs_process.sh"]