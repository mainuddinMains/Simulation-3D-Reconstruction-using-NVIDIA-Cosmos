x-gpu-common: &gpu-common
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]

x-gpu-build-args: &gpu-build-args
  args:
    CUDA_HOME: "/usr/local/cuda"
    TORCH_CUDA_ARCH_LIST: "${TORCH_CUDA_ARCH_LIST}"

services:
  preprocessor:
    build: ./modules/preprocessor
    image: preprocessor:latest
    container_name: preprocessor_container
    environment:
      SCENE_NAME: ${SCENE_NAME}
      FPS_EXTRACT: ${FPS_EXTRACT}
      CAPTURE_FRAMERATE: ${CAPTURE_FRAMERATE}
    volumes:
      - ./data:/data
    command: ["./pre_process.sh"] 

  da3:
    <<: *gpu-common
    build:
      <<: *gpu-build-args
      context: ./modules/da3
    image: da3:latest
    container_name: da3_container
    environment:
      SCENE_NAME: ${SCENE_NAME}
      DATA_ROOT: ${DATA_ROOT}
      DA3_MODEL_DIR: ${DA3_MODEL_DIR}
    volumes:
      - ./data:/data
      - ./data/cache/da3:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["python3", "./da3_process.py"]


  sam3:
    <<: *gpu-common
    build: ./modules/sam3
    image: sam3:latest
    container_name: sam3_container
    environment:
      HF_TOKEN: ${HF_TOKEN}
      SCENE_NAME: ${SCENE_NAME}
      DATA_ROOT: ${DATA_ROOT}
      SAM3_MIN_SCORE: ${SAM3_MIN_SCORE}
    volumes:
      - ./data:/data
      - ./data/cache/sam3:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./modules/sam3/prompts.txt:/app/sam3/prompts.txt
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["python3", "./sam3_process.py"]

  holoscene:
    <<: *gpu-common
    build:
      <<: *gpu-build-args
      context: ./modules/holoscene
    image: holoscene:latest
    container_name: holoscene_container
    ipc: host
    environment:
      SCENE_NAME: ${SCENE_NAME}
      DATA_ROOT: ${DATA_ROOT}
      WANDB_MODE: disabled
    volumes:
      - ./data:/data
      - ./data/cache/holoscene:/root/.cache
      - ./docker-entrypoint.sh:/usr/local/bin/docker-entrypoint.sh:ro
      - ./data/output:/holoscene/exps
    entrypoint: ["/usr/local/bin/docker-entrypoint.sh"]
    command: ["./hs_process.sh"] 